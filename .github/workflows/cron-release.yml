name: Create New Tag and Publish Release

on:
  schedule:
    - cron: "0 0 */3 * *"  # Runs every 3 days at midnight UTC
  workflow_dispatch:
    inputs:
      custom_tag:
        description: 'Optional tag to use for the release (e.g., v1.2.3)'
        required: false

jobs:
  check-draft:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v4

      - name: Check if draft release exists
        id: check_draft
        run: |
          DRAFT_RELEASE=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                                -H "Accept: application/vnd.github.v3+json" \
                                https://api.github.com/repos/${{ github.repository }}/releases \
                            | jq '.[] | select(.draft == true) | .id')
          echo "Draft release ID: $DRAFT_RELEASE"
          if [ -z "$DRAFT_RELEASE" ]; then
            echo "::set-output name=draft_exists::false"
          else
            echo "::set-output name=draft_exists::true"
          fi

  create-semver-tag:
    needs: check-draft
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v4

      - name: Set condition for creating a tag
        id: should_create_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "::set-output name=should_create_tag::true"
          elif [ "${{ needs.check-draft.outputs.draft_exists }}" == "true" ]; then
            echo "::set-output name=should_create_tag::true"
          else
            echo "::set-output name=should_create_tag::false"
          fi

      - name: Skip job if no draft or manual trigger
        if: steps.should_create_tag.outputs.should_create_tag == 'false'
        run: echo "No draft release or manual trigger. Skipping."

      - name: Determine tag to use
        id: get-latest-tag
        if: steps.should_create_tag.outputs.should_create_tag == 'true'
        uses: actions-ecosystem/action-get-latest-tag@v1

      - name: Create new semantic version tag (if no custom tag provided)
        id: create_tag
        if: steps.determine_tag.outputs.tag == ''
        uses: actions-ecosystem/action-bump-semver@v1
        with:
          current_version: ${{ steps.determine_tag.outputs.tag }}
          level: patch  # Can be patch, minor, or major
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set final tag (either custom or new)
        id: set_tag
        if: steps.should_create_tag.outputs.should_create_tag == 'true'
        run: |
          if [ "${{ steps.determine_tag.outputs.tag }}" ]; then
            FINAL_TAG="${{ steps.determine_tag.outputs.tag }}"
          else
            FINAL_TAG="${{ steps.create_tag.outputs.new_tag }}"
          fi
          echo "Final tag: $FINAL_TAG"
          echo "::set-output name=final_tag::$FINAL_TAG"

  publish-release:
    needs: create-semver-tag
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v4

      - name: Skip job if no draft or manual trigger
        if: needs.create-semver-tag.outputs.should_create_tag == 'false'
        run: echo "Skipping release publishing as no new tag was created."

      - name: Publish the release
        if: needs.create-semver-tag.outputs.should_create_tag == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.set_tag.outputs.final_tag }}  # Use the manually provided or automatically generated tag
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
