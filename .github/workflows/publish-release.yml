name: Publish New Release

on:
  schedule:
    - cron: "0 0 */3 * *"  # Runs every 3 days at midnight UTC
  workflow_dispatch:
    inputs:
      custom_tag:
        description: 'Optional tag to use for the release (e.g., v1.2.3)'
        required: false

jobs:
  check-draft-exists:
    runs-on: ubuntu-latest
    outputs:
      draft_exists: ${{ steps.check_draft.outputs.draft_exists }}
    steps:
      - name: Check out the repository
        uses: actions/checkout@v4

      - name: Check if draft release exists
        id: check_draft
        run: |
          DRAFT_RELEASE=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                                -H "Accept: application/vnd.github.v3+json" \
                                https://api.github.com/repos/${{ github.repository }}/releases \
                            | jq '.[] | select(.draft == true) | .id')
          echo "Draft release ID: $DRAFT_RELEASE"
          if [ -z "$DRAFT_RELEASE" ]; then
            echo "draft_exists=false" >> $GITHUB_OUTPUT
          else
            echo "draft_exists=true" >> $GITHUB_OUTPUT
          fi

  create-semver-tag:
    needs: check-draft-exists
    runs-on: ubuntu-latest
    outputs:
      should_create_tag: ${{ steps.should_create_tag.outputs.should_create_tag }}
      final_tag: ${{ steps.set_tag.outputs.final_tag }}
    steps:
      - name: Check out the repository
        uses: actions/checkout@v4

      - name: Set condition for creating a tag
        id: should_create_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_create_tag=true" >> $GITHUB_OUTPUT
          elif [ "${{ needs.check-draft-exists.outputs.draft_exists }}" == "true" ]; then
            echo "should_create_tag=true" >> $GITHUB_OUTPUT
          else
            echo "should_create_tag=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip job if no draft or manual trigger
        if: steps.should_create_tag.outputs.should_create_tag == 'false'
        run: echo "No draft release or manual trigger. Skipping."

      - name: Determine tag to use
        id: get-latest-tag
        if: steps.should_create_tag.outputs.should_create_tag == 'true'
        uses: actions-ecosystem/action-get-latest-tag@v1

      - name: Create new semantic version tag (if no custom tag provided)
        id: create_tag
        if: steps.get-latest-tag.outputs.tag == ''
        uses: actions-ecosystem/action-bump-semver@v1
        with:
          current_version: ${{ steps.get-latest-tag.outputs.tag }}
          level: patch  # Can be patch, minor, or major
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set final tag (either custom or new)
        id: set_tag
        if: steps.should_create_tag.outputs.should_create_tag == 'true'
        run: |
          if [ "${{ github.event.inputs.custom_tag }}" ]; then
            FINAL_TAG="${{ github.event.inputs.custom_tag }}"
          else
            FINAL_TAG="${{ steps.create_tag.outputs.new_version }}"
          fi
          echo "Final tag: $FINAL_TAG"
          echo "final_tag=$FINAL_TAG" >> $GITHUB_OUTPUT

  publish-release:
    needs: create-semver-tag
    runs-on: ubuntu-latest
    steps:

      - name: Check out the repository
        uses: actions/checkout@v4

      - name: Skip job if no draft or manual trigger
        if: needs.create-semver-tag.outputs.should_create_tag == 'false'
        run: echo "Skipping release publishing as no new tag was created."

      - name: Publish the release
        if: needs.create-semver-tag.outputs.should_create_tag == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-semver-tag.outputs.final_tag }}
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
